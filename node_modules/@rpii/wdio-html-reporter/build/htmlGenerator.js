"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

const Handlebars = require('handlebars');

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const encode = require('./encode').default;

const moment = require('moment');

const logger = require('@log4js-node/log4js-api');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlGenerator {
  static htmlOutput(reportOptions, callback = () => {}) {
    try {
      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation started");
      }

      let templateFile = fs.readFileSync(reportOptions.templateFilename, 'utf8');
      Handlebars.registerHelper('imageAsBase64', function (screenshotFile, screenshotPath, hbopts) {
        // occurs when there is an error file
        if (!fs.existsSync(screenshotFile)) {
          if (screenshotPath) {
            screenshotFile = `${screenshotPath}/${screenshotFile}`;
          } else {
            screenshotFile = `${screenshotFile}`;
          }
        }

        return encode(path.resolve(screenshotFile));
      });
      Handlebars.registerHelper('isValidReport', function (suites, hbopts) {
        if (suites && suites.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('isValidSuite', function (suite, hbopts) {
        if (suite.title.length > 0 && suite.type === 'suite' && suite.tests.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('testStateColour', function (state, hbopts) {
        if (state === 'passed') {
          return 'test-pass';
        } else if (state === 'failed') {
          return 'test-fail';
        } else if (state === 'pending') {
          return 'test-pending';
        } else if (state === 'skipped') {
          return 'test-skipped';
        }
      });
      Handlebars.registerHelper('testStateIcon', function (state, hbopts) {
        if (state === 'passed') {
          return '<span class="success">&#10004;</span>';
        } else if (state === 'failed') {
          return '<span class="error">&#10006;</span>';
        } else if (state === 'pending') {
          return '<span class="pending">&#10004;</span>';
        } else if (state === 'skipped') {
          return '<span class="skipped">&#10034;</span>';
        }
      });
      Handlebars.registerHelper('suiteStateColour', function (tests, hbopts) {
        let numTests = Object.keys(tests).length;

        _.values(tests).find(test => {
          if (test.state === "pending") {
            --numTests;
          }
        });

        let fail = _.values(tests).find(test => {
          return test.state === 'failed';
        });

        if (fail != null) {
          return 'suite-fail';
        }

        let passes = _.values(tests).filter(test => {
          return test.state === 'passed';
        });

        if (passes.length === numTests && numTests > 0) {
          return 'suite-pass';
        } //skipped is the lowest priority check


        let skipped = _.values(tests).find(test => {
          return test.state === 'skipped';
        });

        if (skipped != null) {
          return 'suite-pending';
        }

        return 'suite-unknown';
      });
      Handlebars.registerHelper('humanizeDuration', function (duration, hbopts) {
        return moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
          trim: false
        });
      });
      Handlebars.registerHelper('ifSuiteHasTests', function (testsHash, hbopts) {
        if (Object.keys(testsHash).length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsError', function (event, hbopts) {
        if (event.type.includes('Error')) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsScreenshot', function (event, hbopts) {
        if (event.type === 'screenshot') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsLogMessage', function (event, hbopts) {
        if (event.type === 'log') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifCollapseTests', function (text, hbopts) {
        return reportOptions.collapseTests;
      });
      Handlebars.registerHelper('logClass', function (text, hbopts) {
        if (text.includes('Test Iteration')) {
          return "test-iteration";
        } else {
          return "log-output";
        }
      });
      Object.keys(reportOptions.templateFuncs).forEach(key => {
        Handlebars.registerHelper(key, reportOptions.templateFuncs[key]);
      });

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        let jsonFile = reportOptions.reportFile.replace('.html', '.json');
        fs.outputFileSync(jsonFile, JSON.stringify(reportOptions.data));
      }

      let template = Handlebars.compile(templateFile);
      let html = template(reportOptions.data);

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        fs.outputFileSync(reportOptions.reportFile, html);
      }

      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation completed");
      }

      callback(true);
    } catch (ex) {
      if (reportOptions.LOG) {
        reportOptions.LOG.error("Html Generation processing ended in error: " + ex);
      }

      callback(false);
    }
  }

}

var _default = HtmlGenerator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odG1sR2VuZXJhdG9yLmpzIl0sIm5hbWVzIjpbIkhhbmRsZWJhcnMiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aCIsImVuY29kZSIsImRlZmF1bHQiLCJtb21lbnQiLCJsb2dnZXIiLCJtb21lbnREdXJhdGlvbkZvcm1hdFNldHVwIiwiSHRtbEdlbmVyYXRvciIsImh0bWxPdXRwdXQiLCJyZXBvcnRPcHRpb25zIiwiY2FsbGJhY2siLCJMT0ciLCJkZWJ1ZyIsInRlbXBsYXRlRmlsZSIsInJlYWRGaWxlU3luYyIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZWdpc3RlckhlbHBlciIsInNjcmVlbnNob3RGaWxlIiwic2NyZWVuc2hvdFBhdGgiLCJoYm9wdHMiLCJleGlzdHNTeW5jIiwicmVzb2x2ZSIsInN1aXRlcyIsImxlbmd0aCIsImZuIiwiaW52ZXJzZSIsInN1aXRlIiwidGl0bGUiLCJ0eXBlIiwidGVzdHMiLCJzdGF0ZSIsIm51bVRlc3RzIiwiT2JqZWN0Iiwia2V5cyIsInZhbHVlcyIsImZpbmQiLCJ0ZXN0IiwiZmFpbCIsInBhc3NlcyIsImZpbHRlciIsInNraXBwZWQiLCJkdXJhdGlvbiIsImZvcm1hdCIsInRyaW0iLCJ0ZXN0c0hhc2giLCJldmVudCIsImluY2x1ZGVzIiwidGV4dCIsImNvbGxhcHNlVGVzdHMiLCJ0ZW1wbGF0ZUZ1bmNzIiwiZm9yRWFjaCIsImtleSIsInBhdGhFeGlzdHNTeW5jIiwib3V0cHV0RGlyIiwianNvbkZpbGUiLCJyZXBvcnRGaWxlIiwicmVwbGFjZSIsIm91dHB1dEZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsImRhdGEiLCJ0ZW1wbGF0ZSIsImNvbXBpbGUiLCJodG1sIiwiZXgiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQ0EsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUExQjs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1B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UjtBQUNILEtBMUpELENBMEpFLE9BQU1zRCxFQUFOLEVBQVU7QUFDUixVQUFJdkQsYUFBYSxDQUFDRSxHQUFsQixFQUF1QjtBQUNuQkYsUUFBQUEsYUFBYSxDQUFDRSxHQUFkLENBQWtCc0QsS0FBbEIsQ0FBd0IsZ0RBQWdERCxFQUF4RTtBQUNIOztBQUNEdEQsTUFBQUEsUUFBUSxDQUFDLEtBQUQsQ0FBUjtBQUNIO0FBQ0o7O0FBbktnQjs7ZUFzS05ILGEiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuY29uc3QgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IGVuY29kZSA9IHJlcXVpcmUoJy4vZW5jb2RlJykuZGVmYXVsdDtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ0Bsb2c0anMtbm9kZS9sb2c0anMtYXBpJyk7XHJcblxyXG5jb25zdCBtb21lbnREdXJhdGlvbkZvcm1hdFNldHVwID0gcmVxdWlyZShcIm1vbWVudC1kdXJhdGlvbi1mb3JtYXRcIik7XHJcbm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAobW9tZW50KTtcclxuXHJcbmNsYXNzIEh0bWxHZW5lcmF0b3IgIHtcclxuXHJcbiAgICBzdGF0aWMgaHRtbE91dHB1dChyZXBvcnRPcHRpb25zLCBjYWxsYmFjayA9ICgpID0+e30pIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmRlYnVnKFwiSHRtbCBHZW5lcmF0aW9uIHN0YXJ0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRmlsZW5hbWUsICd1dGY4Jyk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpbWFnZUFzQmFzZTY0JywgZnVuY3Rpb24gKHNjcmVlbnNob3RGaWxlLCBzY3JlZW5zaG90UGF0aCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBvY2N1cnMgd2hlbiB0aGVyZSBpcyBhbiBlcnJvciBmaWxlXHJcbiAgICAgICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyZWVuc2hvdEZpbGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbnNob3RQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbnNob3RGaWxlID0gYCR7c2NyZWVuc2hvdFBhdGh9LyR7c2NyZWVuc2hvdEZpbGV9YFxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbnNob3RGaWxlID0gYCR7c2NyZWVuc2hvdEZpbGV9YFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBlbmNvZGUocGF0aC5yZXNvbHZlKHNjcmVlbnNob3RGaWxlKSkgO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lzVmFsaWRSZXBvcnQnLCBmdW5jdGlvbiAoc3VpdGVzLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWl0ZXMgJiYgc3VpdGVzLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lzVmFsaWRTdWl0ZScsIGZ1bmN0aW9uIChzdWl0ZSwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3VpdGUudGl0bGUubGVuZ3RoID4gMCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHN1aXRlLnR5cGUgPT09ICdzdWl0ZScgJiZcclxuICAgICAgICAgICAgICAgICAgICBzdWl0ZS50ZXN0cy5sZW5ndGggPiAwICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndGVzdFN0YXRlQ29sb3VyJywgZnVuY3Rpb24gKHN0YXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gJ3Bhc3NlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3QtcGFzcyc7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnZmFpbGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1mYWlsJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdwZW5kaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1wZW5kaW5nJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdza2lwcGVkJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LXNraXBwZWQnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndGVzdFN0YXRlSWNvbicsIGZ1bmN0aW9uIChzdGF0ZSwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09ICdwYXNzZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cInN1Y2Nlc3NcIj4mIzEwMDA0Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdmYWlsZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cImVycm9yXCI+JiMxMDAwNjs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAncGVuZGluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwicGVuZGluZ1wiPiYjMTAwMDQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3NraXBwZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cInNraXBwZWRcIj4mIzEwMDM0Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdzdWl0ZVN0YXRlQ29sb3VyJywgZnVuY3Rpb24gKHRlc3RzLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGxldCBudW1UZXN0cyA9IE9iamVjdC5rZXlzKHRlc3RzKS5sZW5ndGg7XHJcblxyXG4gICAgICAgICAgICAgICAgXy52YWx1ZXModGVzdHMpLmZpbmQoKHRlc3QpID0+IHtcclxuICAgICAgICAgICAgICAgICAgaWYgKHRlc3Quc3RhdGUgPT09IFwicGVuZGluZ1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLS1udW1UZXN0cztcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGZhaWwgPSBfLnZhbHVlcyh0ZXN0cykuZmluZCgodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09PSAnZmFpbGVkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAoZmFpbCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1mYWlsJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcGFzc2VzID0gXy52YWx1ZXModGVzdHMpLmZpbHRlcigodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09PSAncGFzc2VkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAocGFzc2VzLmxlbmd0aCA9PT0gbnVtVGVzdHMgJiYgbnVtVGVzdHMgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1wYXNzJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvL3NraXBwZWQgaXMgdGhlIGxvd2VzdCBwcmlvcml0eSBjaGVja1xyXG4gICAgICAgICAgICAgICAgbGV0IHNraXBwZWQgPSBfLnZhbHVlcyh0ZXN0cykuZmluZCgodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0LnN0YXRlID09PSAnc2tpcHBlZCc7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgaWYgKHNraXBwZWQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnc3VpdGUtcGVuZGluZyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS11bmtub3duJ1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2h1bWFuaXplRHVyYXRpb24nLCBmdW5jdGlvbiAoZHVyYXRpb24sIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbihkdXJhdGlvbiwgXCJtaWxsaXNlY29uZHNcIikuZm9ybWF0KCdoaDptbTpzcy5TUycsIHt0cmltOiBmYWxzZX0pXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZTdWl0ZUhhc1Rlc3RzJywgZnVuY3Rpb24gKHRlc3RzSGFzaCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXModGVzdHNIYXNoKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNFcnJvcicsIGZ1bmN0aW9uIChldmVudCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZS5pbmNsdWRlcygnRXJyb3InKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZFdmVudElzU2NyZWVuc2hvdCcsIGZ1bmN0aW9uIChldmVudCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ3NjcmVlbnNob3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNMb2dNZXNzYWdlJywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAnbG9nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZDb2xsYXBzZVRlc3RzJywgZnVuY3Rpb24gKHRleHQgLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXBvcnRPcHRpb25zLmNvbGxhcHNlVGVzdHM7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbG9nQ2xhc3MnLCBmdW5jdGlvbiAodGV4dCAsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRleHQuaW5jbHVkZXMoJ1Rlc3QgSXRlcmF0aW9uJykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJ0ZXN0LWl0ZXJhdGlvblwiO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJsb2ctb3V0cHV0XCI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3MpLmZvckVhY2goKGtleSk9PntcclxuICAgICAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoa2V5LCByZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3Nba2V5XSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZzLnBhdGhFeGlzdHNTeW5jKHJlcG9ydE9wdGlvbnMub3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICBsZXQganNvbkZpbGUgPSByZXBvcnRPcHRpb25zLnJlcG9ydEZpbGUucmVwbGFjZSgnLmh0bWwnICwgJy5qc29uJykgO1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKGpzb25GaWxlLCBKU09OLnN0cmluZ2lmeShyZXBvcnRPcHRpb25zLmRhdGEpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlRmlsZSk7XHJcbiAgICAgICAgICAgIGxldCBodG1sID0gdGVtcGxhdGUocmVwb3J0T3B0aW9ucy5kYXRhKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChmcy5wYXRoRXhpc3RzU3luYyhyZXBvcnRPcHRpb25zLm91dHB1dERpcikpIHtcclxuICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSwgaHRtbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlcG9ydE9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRPcHRpb25zLkxPRy5kZWJ1ZyhcIkh0bWwgR2VuZXJhdGlvbiBjb21wbGV0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XHJcbiAgICAgICAgfSBjYXRjaChleCkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmVycm9yKFwiSHRtbCBHZW5lcmF0aW9uIHByb2Nlc3NpbmcgZW5kZWQgaW4gZXJyb3I6IFwiICsgZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEh0bWxHZW5lcmF0b3I7XHJcbiJdfQ==